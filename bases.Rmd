---
title: "mirta"
author: "SL"
date: "July 1, 2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(tidyverse)
library(viridis)
library(rvest)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(lwgeom)

```

## Load MIRTA Data
Accessed from: https://catalog.data.gov/dataset/military-installations-ranges-and-training-areas
Metadata updated date: January 18, 2017
```{r load_shapefile}
#Ref: http://strimas.com/r/tidy-sf/
bases <- st_read("installations_ranges/MIRTA_Boundaries.shp") %>% 
  janitor::clean_names()


# convert to SpatialPolygonsDataFrame
# bases_sp <- as(bases, "Spatial")

class(bases)
glimpse(bases)
st_crs(bases)

as_tibble(bases)
```


## Select Active Army Installations

Note: FSH, TX listed under Air Force; Fort Benning split between GA and AL
```{r select_army}
bases %>% 
  filter(component == "Army Active") %>% 
  .$site_name

```


## Feature information
```{r feature_information}
bases_geom <- st_geometry(bases)
st_geometry(bases) %>% class()
attributes(bases_geom)
bases_geom[[1]] %>% class
```


## Inspection plot - world
```{r world_plot}

world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot() +
  geom_sf(data = world, fill = NA) +
  geom_sf(data = bases, color = "darkgreen", fill = "lightgreen") +
  ggtitle("DoD Installations") +
  theme_bw()

```

## Select specific installations

```{r select_bases}
army_select <-
bases %>% 
  filter(.$site_name %in% c("Fort Bragg", "Fort Benning GA", "Fort Benning", "Fort Campbell" ))

ggplot(army_select) +
  ggtitle("Bragg. Benning, Campbell") +
  geom_sf() +
  theme_bw()

bragg <-
bases %>% 
  filter(.$site_name == "Fort Bragg")

# Save shapefile
# st_write(bragg, "bragg.shp")

st_centroid(bragg) %>% 
  as.tibble()

bragg_centroid <- st_centroid(bragg)

ggplot(bragg) +
  ggtitle("Fort Bragg") +
  geom_sf() +
  theme_bw()


ggplot(bases %>% 
  filter(.$site_name %in% c("Fort Benning GA", "Fort Benning"))) +
  ggtitle("Fort Benning") +
  geom_sf() +
  theme_bw()

```


## Load NLDAS grids
NLDAS grid shapefile from: https://ldas.gsfc.nasa.gov/sites/default/files/ldas/nldas/NLDAS_Grid_Reference.zip

```{r load_nldas_grid}

nldas_grid <- st_read("nldas_grids/NLDAS_Grid_Reference.shp") %>% 
  janitor::clean_names()

class(nldas_grid)
glimpse(nldas_grid)
st_crs(nldas_grid)

as_tibble(nldas_grid)



```


## NLDAS and Installation Grid Overlap and Weighted Averages

```{r nldas_intersection}

bragg_nldas <-
  st_intersection(bragg, nldas_grid) %>% 
  mutate(area = sf::st_area(.),
         weight = area / sum(area))

bragg_nldas

sum(bragg_nldas$area)
sum(bragg_nldas$weight)
st_area(bragg_nldas) 


ggplot(bragg_nldas) + 
  ggtitle("Fort Bragg NLDAS grids") +
  geom_sf() +
  geom_label(data = bragg_nldas, aes(x = centerx, y = centery, label = nldas_id), size = 3, fontface = "bold") +
  geom_text(data = bragg_nldas, aes(x = centerx, y = centery, label =  formatC(weight, format = "f", digits = 3)) , size = 3, position = position_nudge(y = -0.02)) +
  theme_bw()

```

## Bounding box for installation
```{r bounding_box}
st_bbox(bragg) %>% 
  .[c("ymin", "xmin", "ymax", "xmax")]


bb_bragg <- st_as_sfc(st_bbox(bragg))
class(bb_bragg)

ggplot() +
  geom_sf(data = bragg_nldas) +
  geom_sf(data = bb_bragg , color = "blue", fill = "NA") +
  geom_sf(data = bragg_centroid, color = "red") +
  ggtitle("Fort Bragg Bounding Box") +
  geom_label(data = bragg_nldas, aes(x = centerx, y = centery, label = nldas_id), size = 3, fontface = "bold") +
  geom_text(data = bragg_nldas, aes(x = centerx, y = centery, label =  formatC(weight, format = "f", digits = 3)) , size = 3, position = position_nudge(y = -0.02)) +
  theme_bw()


```

