---
title: "nldas_download"
author: "SL"
date: "July 2, 2019"
output: github_document
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
# library(installr)
# installr::system.PATH()

library(ncdf4)
library(devtools)
library(raster)
library(ncdump)
```


```{r wget_path}
# system("C:\Program Files (x86)wget-1.20.3-win64\wget )
```


Earthdata.nasa.gov
Collection: 
NLDAS Primary Forcing Data L4 Hourly 0.125 x 0.125 degree V002 (NLDAS_FORA0125_H) at GES DISC
Homepage: https://ldas.gsfc.nasa.gov/nldas/
Metadata: https://hydro1.gesdisc.eosdis.nasa.gov/data/NLDAS/NLDAS_FORA0125_H.002/doc/gribtab_NLDAS_FORA_hourly.002.txt

Distribution URLs: 

- Simple Subset Wizard (SSW): https://disc.gsfc.nasa.gov/SSW/#keywords=NLDAS_FORA0125_H
(Date range, bounding box, select variables)


SSW Steps:

1. Collection Launch page: https://disc.gsfc.nasa.gov/datasets/NLDAS_FORA0125_H_002/summary
2. Data Access -> Simple Subset Wizard
3. Enter Date Range and Spatial Bounding Box coordinates 
  (S, W, N, E  -->  ymin, xmin, ymax, xmax)
4. Click "Search for data sets"" box
5. Select variables from dropdown (all 11); choice of "GRIB" or "netCDF" -> netCDF
6. Click "subset selected data sets"
7. Click "View selected data sets"
8. Download Manager: https://chrome.google.com/webstore/detail/chrono-download-manager
  - Chrono Sniffer -> Application -> select links (120 in 5-day week test)
  - select all
  - click "download all" 
  - about 6 minutes for 120 files
  
  
  
```{r bragg_test_nldas}

# https://www.r-bloggers.com/a-netcdf-4-in-r-cheatsheet/
# Retrieve a list of nc files in data folder:
file_list <- list.files(path = "nldas_data/bragg_test/", pattern = "^.*\\.(nc|NC|Nc|Nc)$")
file_list %>% head()



```

## Inspect first ncdf file
```{r inspect_first}

# Open a connection to the first file in  list
nc1 <- ncdf4::nc_open(paste0("nldas_data/bragg_test/", file_list[1]))
# print(nc1)


# Get a list of the NetCDF's R attributes:
attributes(nc1)$names

print(paste("The file has",nc1$nvars,"variables,",nc1$ndims,"dimensions and",nc1$natts,"NetCDF attributes"))

# Get a list of the nc variable names.
attributes(nc1$var)$names

# View temperature variable's nc attributes
ncdf4::ncatt_get(nc1, attributes(nc1$var)$names[10])

# Retrieve a matrix of the data using the ncvar_get function
temp <- ncvar_get(nc1, attributes(nc1$var)$names[10])

# Print the data's dimensions
dim(temp)

# Retrieve the latitude and longitude dimensions
attributes(nc1$dim)$names

nc1_lat <- ncvar_get(nc1, attributes(nc1$dim)$names[1])
nc1_lon <- ncvar_get(nc1, attributes(nc1$dim)$names[2])

print(paste(dim(nc1_lat), "latitudes and", dim(nc1_lon), "longitudes"))

```

## Variable names
```{r}
var_names <- attributes(nc1$var)$names

long_names <- vector("character", length = 11)
  
for (i in 1:11) {
   long_names[[i]] <- ncatt_get(nc1, attributes(nc1$var)$names[[i]])$long_name
}
long_names

short_names <- c("evap", "longwave", "shortwave", "cape", "con_frac", "precip", "sp_humid", "merid_wind", "zonal_wind", "temperature", "pressure")

variables <- as_tibble(cbind(var_names, long_names, short_names))
variables


var_list <- list(
  var_row = 1:nrow(variables),          
  var_name = variables$short_names
)


# Review initial time in nc1 for each variable
for (i in 1:11) {
   print(ncatt_get(nc1, attributes(nc1$var)$names[i])$initial_time)
}




```

## Metadata

```{r}
ncdump::NetCDF(paste0("nldas_data/bragg_test/", file_list[1]))

```

```{r print_list, eval = FALSE}

print_list <- function(list) {
  for (item in 1:length(list)) {
    print(head(list[[item]]))
  }
}
print_list(nc1)
```


## Example variable matrix by lat/long
```{r}
# Change the dimension names of our matrix to "lon" and "lat" 
# Change the row and column names to the latitude and longitude values

dimnames(temp) <- 
  list(lon = nc1_lon, lat = nc1_lat) 
temp

# Transpose matrix

temp <- t(temp)
temp

```


## Global attributes

```{r}
# Retrieve global attributes
nc1_atts <- ncatt_get(nc1, 0)
nc1_atts

# Close the connection to the nc file
nc_close(nc1)
```


## Processing multiple netCDF files

```{r nc_read_function}

## Nested loop

tidy_ncdf <- function(files) {
     for (i in seq_along(files)) {
      for (j in seq_along(var_list$var_row)) {   
        # open a conneciton to the ith nc file
        nc_store <- nc_open(paste0("nldas_data/bragg_test/", files[i]))
        # store values from variables and atributes
        nc_names <- paste("nc", var_list$var_name[j], sep = "_")
        nc_names <- ncvar_get(nc_store, attributes(nc_store$var)$names[var_list$var_row[j]])
        nc_time <- ncatt_get(nc_store, attributes(nc_store$var)$names[var_list$var_row[j]])$initial_time
        nc_lat <- ncvar_get(nc_store, attributes(nc_store$dim)$names[1])
        nc_lon <- ncvar_get(nc_store, attributes(nc_store$dim)$names[2])
        # close the connection 
        nc_close(nc_store)
        # set the dimension names and values of your matrix to the appropriate latitude and longitude values
        dimnames(nc_names) <- list(lon = nc_lon, lat = nc_lat)

        store_nc_names <- nc_names %>% reshape2::melt(., value.name = var_list$var_name[j]) %>% 
          gather(., key = variable, value = value, var_list$var_name[j]) %>% 
          mutate(time = nc_time)

        # set the name of new variable and bind the new data to it
        if (exists("var_data")) {
            var_data <- bind_rows(var_data, store_nc_names)
 
        }else{
            var_data <- store_nc_names

          }
      }
     }
    return(var_data)
}


data <- tidy_ncdf(file_list)
as_tibble(data)

data %>% 
  tibble::rowid_to_column() %>%
   spread(variable, value) %>% 
  group_by(lat, lon) %>% 
   summarise_each(funs(mean(., na.rm = TRUE)))






```



