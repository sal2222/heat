---
title: "nldas_download"
author: "SL"
date: "July 2, 2019"
output: github_document
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
# library(installr)
# installr::system.PATH()

library(ncdf4)
library(devtools)
library(raster)
library(ncdump)
```


```{r wget_path}
# system("C:\Program Files (x86)wget-1.20.3-win64\wget )
```


Earthdata.nasa.gov
Collection: 
NLDAS Primary Forcing Data L4 Hourly 0.125 x 0.125 degree V002 (NLDAS_FORA0125_H) at GES DISC
Homepage: https://ldas.gsfc.nasa.gov/nldas/
Metadata: https://hydro1.gesdisc.eosdis.nasa.gov/data/NLDAS/NLDAS_FORA0125_H.002/doc/gribtab_NLDAS_FORA_hourly.002.txt

Distribution URLs: 

- Simple Subset Wizard (SSW): https://disc.gsfc.nasa.gov/SSW/#keywords=NLDAS_FORA0125_H
(Date range, bounding box, select variables)


SSW Steps:

1. Collection Launch page: https://disc.gsfc.nasa.gov/datasets/NLDAS_FORA0125_H_002/summary
2. Data Access -> Simple Subset Wizard
3. Enter Date Range and Spatial Bounding Box coordinates 
  (S, W, N, E  -->  ymin, xmin, ymax, xmax)
4. Click "Search for data sets"" box
5. Select variables from dropdown (all 11); choice of "GRIB" or "netCDF" -> netCDF
6. Click "subset selected data sets"
7. Click "View selected data sets"
8. Download Manager: https://chrome.google.com/webstore/detail/chrono-download-manager
  - Chrono Sniffer -> Application -> select links (120 in 5-day week test)
  - select all
  - click "download all" 
  - about 6 minutes for 120 files
  
  
  
```{r bragg_test_nldas}

# https://www.r-bloggers.com/a-netcdf-4-in-r-cheatsheet/
# Retrieve a list of nc files in data folder:
file_list <- list.files(path = "nldas_data/bragg_test/", pattern = "^.*\\.(nc|NC|Nc|Nc)$")
file_list %>% head()



```

## Inspect first ncdf file
```{r inspect_first}

# Open a connection to the first file in  list
nc1 <- ncdf4::nc_open(paste0("nldas_data/bragg_test/", file_list[1]))
print(nc1)


# Get a list of the NetCDF's R attributes:
attributes(nc1)$names

print(paste("The file has",nc1$nvars,"variables,",nc1$ndims,"dimensions and",nc1$natts,"NetCDF attributes"))

# Get a list of the nc variable names.
attributes(nc1$var)$names

# View temperature variable's nc attributes
ncdf4::ncatt_get(nc1, attributes(nc1$var)$names[10])

# Retrieve a matrix of the data using the ncvar_get function
temp <- ncvar_get(nc1, attributes(nc1$var)$names[10])

# Print the data's dimensions
dim(temp)

# Retrieve the latitude and longitude dimensions
attributes(nc1$dim)$names

nc1_lat <- ncvar_get(nc1, attributes(nc1$dim)$names[1])
nc1_lon <- ncvar_get(nc1, attributes(nc1$dim)$names[2])

print(paste(dim(nc1_lat), "latitudes and", dim(nc1_lon), "longitudes"))

```

## Metadata


```{r}
ncdump::NetCDF(paste0("nldas_data/bragg_test/", file_list[1]))

```


```{r print_list}

print_list <- function(list) {

  for (item in 1:length(list)) {

    print(head(list[[item]]))

  }
}

print_list(nc1)
```


## Variable matrix by lat/long
```{r}
# Change the dimension names of our matrix to "lon" and "lat" 
# Change the row and column names to the latitude and longitude values

dimnames(temp) <- 
  list(lon = nc1_lon, lat = nc1_lat) 

temp

# Transpose matrix

temp <- t(temp)
temp

```


## Global attributes

```{r}
# Retrieve global attributes
nc1_atts <- ncatt_get(nc1, 0)
nc1_atts


# Close the connection to the nc file
nc_close(nc1)
```


## Processing multiple netCDF files

```{r eval=FALSE}
# Define our function
process_nc <- function(files) {
    # iterate through the nc
    for (i in 1:length(files)) {
        # open a conneciton to the ith nc file
        nc_tmp <- nc_open(paste0("nldas_data/bragg_test/", files[i]))
        # store values from variables and atributes
        nc_temp <- ncvar_get(nc_tmp, attributes(nc_tmp$var)$names[10])
        nc_lat <- ncvar_get(nc_tmp, attributes(nc_tmp$dim)$names[1])
        nc_lon <- ncvar_get(nc_tmp, attributes(nc_tmp$dim)$names[2])
        nc_atts <- ncatt_get(nc_tmp, 0)
        # close the connection sice were finished
        nc_close(nc_tmp)
        # set the dimension names and values of your matrix to the appropriate latitude and longitude values
        dimnames(nc_temp) <- list(lon = nc_lon, lat = nc_lat)
        tmp_temp_df <- reshape2::melt(nc_temp, value.name = "temp")
        # set the name of my new variable and bind the new data to it
        if (exists("temp_data")) {
            temp_data <- bind_rows(temp_data, tmp_temp_df)
        }else{
            temp_data <- tmp_temp_df
        }
      }

    return(temp_data)
}

nc1

nc1$var$TMP2m_110_HTGL$initial_time
nc1$var$TMP2m_110_HTGL$longname
ncvar_get(nc1, attributes(nc1$var)$names[10])

str(nc1)


tidy_ncdf <- function(files) {
    # iterate through the nc
    for (i in 1:length(files)) {
        # open a conneciton to the ith nc file
        nc_store <- nc_open(paste0("nldas_data/bragg_test/", files[i]))
        # store values from variables and atributes
        nc_temp <- ncvar_get(nc_store, attributes(nc_store$var)$names[10])
        nc_humid <- ncvar_get(nc_store, attributes(nc_store$var)$names[7])
        nc_lat <- ncvar_get(nc_store, attributes(nc_store$dim)$names[1])
        nc_lon <- ncvar_get(nc_store, attributes(nc_store$dim)$names[2])
         # close the connection sice were finished
        nc_close(nc_store)
        # set the dimension names and values of your matrix to the appropriate latitude and longitude values
        dimnames(nc_temp) <- list(lon = nc_lon, lat = nc_lat)
        dimnames(nc_humid) <- list(lon = nc_lon, lat = nc_lat)
        store_temp_df <- nc_temp %>% reshape2::melt(., value.name = "temperature") %>% 
          gather(., key = variable, value = value, temperature)
        store_humid_df <- nc_humid %>% reshape2::melt(., value.name = "sp_humidity") %>% 
          gather(., key = variable, value = value, sp_humidity)
        # set the name of new variable and bind the new data to it
        if (exists("var_data")) {
            var_data <- bind_rows(var_data, store_temp_df)
            var_data <- bind_rows(var_data, store_humid_df)
        }else{
            var_data <- store_temp_df
            var_data <- bind_rows(var_data, store_humid_df)
            
        }
      }

    return(var_data)
}

data <- tidy_ncdf(file_list)

as.data.frame(data)


nc_lon <- ncvar_get(nc1, attributes(nc1$dim)$names[2])
nc_lat <- ncvar_get(nc1, attributes(nc1$dim)$names[1])
temp <- ncvar_get(nc1, attributes(nc1$var)$names[10]) 
dimnames(temp) <- list(lon = nc_lon, lat = nc_lat)
temp <- temp %>% reshape2::melt(., value.name = "temperature") %>% 
  gather(., key = variable, value = value, temperature)
temp

humid <- ncvar_get(nc1, attributes(nc1$var)$names[7])
dimnames(humid) <- list(lon = nc_lon, lat = nc_lat)
humid <- humid %>% reshape2::melt(., value.name = "humidity") %>% 
  gather(., key = variable, value = value, humidity)
humid
bind_rows(temp, humid)


```


